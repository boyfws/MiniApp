# Бэкенд, дока для КТ2

## Общие сведения

- фреймворк FastAPI для создания API
- SQLAlchemy и ORM для работы с PostgresSQL, подключение реализовано с помощью асинхронного контекстного менеджера
- Motor для работы с MongoDB, подключение также через асинхронный контекстный менеджер
- весь код протестирован на pytest

## Подробнее про реализацию

Как говорилось в основном README, на бэкенде используется слоистая архитектура.

- Слой представления. В этом слое мы подготавливаем данные для представления на различных платформах, в нашем случае это будут тг бот и мини-приложение
- Слой сервиса. Подготовка данных для сохранения и дальнейшей обработки. Реализует инкапсуляцию бизнес-операций.
- Слой работы с данными. Мы абстрагируем работу с данными, что позволяет бизнес-логике не зависеть от конкретной реализации слоя работы с данными.


## Обзор файловой структуры

### Папка src

1. **api**. В этой папке первая основная версия апи (v1), которая общается с продакшн базой данных. Каждый сервис, используемый в хендлерах прокидывается, как dependency injection (ну почти), для валидации данных используется Pydantic схемы
2. **app**. Реализация кастомного FastAPI приложение, где подключается CORS и все роутеры
3. **auth**. Функции для работы с JWT аутенфикацией: создание аксес и рефреш токенов, проверка, что запрос пришел из телеграм
4. **database**. Асинхронные коннекторы для работы с базами данных MongoDB и PostgresSQL
5. **models**. Делится на две части: DTO и ORM
    - **DTO** - data transfer object. Просто наборы pydantic моделей для разных задач, которыми обмениваются слои при общении.
    - **ORM** - ORM схемы для работы с PostgresSQL
6. **repository**. Слой репозитория. В интерфейсе определен лишь session_getter - по умолчанию это коннектор к продакшн базе, но в тестах мы можем это подменить на другой, чтобы инкапсулировать тесты.
7. **service**. Слой сервиса.

### Тесты

В другом разделе README есть туториал, как их запустить, но тут я просто расскажу, что там есть:

- Тесты на хендлеры. Используется асинхронный клиент из httpx вместе с веб-сервером uvicorn. Для тестов написан клон API, так как было бы очень плохой идеей делать основной API так, чтобы влиять на то, с какой базой данных будет производиться работа.
- Тесты на репозиторий и сервис. Они в целом очень похожи, но в целом это обычные интеграционные тесты, которые работают с тестовой базой данных
- Всего в проекте 190 тестов, и все проходят. Сейчас осталось протестировать только ручки на хендлеры и ручки, которые будут менять свойства ресторана

### Что сейчас по задачам на бэкенде
1. понять, нужно ли допиливать jwt или все работает, как надо
2. дописать хендлеры, которые будут по одному апдейтить свойства ресторана + тесты на них
3. в целом в остальном тут все готово уже и можно ~~пить пиво~~ делать лабу по матану2


Обзор на API и тесты можно чекнуть по ссылке на видеоотчет!