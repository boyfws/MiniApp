# База данных PostgreSQL 

## Используемые расширения 
- pg_trim для удобного и быстрого поиска наиболее похожего названия ресторана 
- postgis для работы с географическими данными  
## Принцип работы (key moments for backend)
1) Все id кроме пользоавательского генерируются автоматически с помощью SMALLSERIAL, SERIAL и BIGSERIAL - указывать их при вставке не нужно
2) Номера телефонов в таблице restaurants хранятся в виде строки из 11 символов и начинаются с 7, введена проверка на это условие для стнадартизации формата хранения 
3) В таблице user автоматически присваивается default значение для owner - false 
4) При вставке/изменении в restaurants не нужно вность location, он автоматически распакуется и добавится из GEOJson из address. 
Также будет проведена проверка формата переданного GEOJson. Это позволит улучшить согласованность данных и защитит от 
возможных ошибок в будущем 
5) Кол-во фото для одного ресторана, которые будут показаны на странице от 3 до 8 включительно
6) В случае если одно из полей адреса пустое - оно устанавливается не в NULL, а с ссылкой на id поля, 
отвечающего за пустую строку. Например, если у нас нет данных о районе то 
```PostgreSQL
address.district = (SELECT id FROM district WHERE name='')
-- Такой элемент гарантироавнно будет существовать в единственном экземпляре 
```
7) В address может возникнуть ситуация, что при пустом district при одинаковых city street и house будут разные location. 
Это необходимо учитывать при добавлении ссылки в таблицу addresses_for_user. Ппри нахождении нескольких id 
с одинаковыми парметрами city, street, house и пустым district необходимо сверить еще и локацию.
Для быстрого поиска и вставки id в таблицу addresses_for_user строится B-TREE индекс на наборе  
(city, district, street, house)
## Пользоавтели 

### reader 
Имеет право только на чтение внутри базы данных, не имееет права на изменение данных и структуры базы данных. 
Роль предназначена для аналитиков и других пользователей БД, от действий которых нужно защитить базу данных 

### backend
Роль предназначена для взаимодействия backend с базой данных. Дает доступ к чтению практически всех таблиц
и к изменению содержания всех необходимых для backend таблиц.

### logger 
Роль для логгера - его основная функция писать в таблицу user_activity_logs, ему предоставлены права на чтение 
связанных таблиц и на INSERT в user_activity_logs

### clearing_trigger 
Данная роль предназначена для микросервиса, который будет запускать операцию очистки таблицы address от повторяющихся значений 

**NOTE: Использоавние ролей позволяет защитить базу данных от ошибок при разработке других частей продукта и от 
нежелательного воздействия. Ни одна из ролей не имеет права создавать новые схемы, менять структуру схемы public, а 
также доступ к изменению таблиц categories и log_actions определяющих систему ограничен для всех ролей**

## Триггеры
1) Триггер на добавление категории в массив вторичных ключей categories в restaurants 
2) Триггер на удаление категории, для поиска ссылок на нее в restaurants в столбце categories
3) Триггер на обновление категории, для поиска ссылок на нее в restaurants в столбце categories
4) Триггер на добавление location при вставке/обновлении в restaurants

## Хранимые процедуры
В БД хранится лишь одна процедура - update_empty_districts

Она будет вызываться раз в некоторое время для "мерджа" записей с одинковыми city, street, house и location 
(i.e обозначающих один адрес) среди который у одной из записей отсутвует district, а у другой - присутствует. 
Выполнение данной процедуры необходимо из-за особенностей используемого на backend-е API, которое может вернуть 
адрес как с district так и без для одной и той же локации. Благодаря ней будет достигаться уникальность хранимых данных 